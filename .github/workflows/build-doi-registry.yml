name: Build DOI Registry

on:
  issues:
    types: [opened, edited, closed, reopened]
  workflow_dispatch:

permissions:
  contents: write
  issues: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Build DOI registry from issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            // Ensure data directory exists
            fs.mkdirSync("data", { recursive: true });

            // Fetch all open issues with label "doi-record"
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: "doi-record",
                state: "open"
              }
            );

            const registry = {};

            // Helper to extract fields from GitHub Issue Form body
            function extract(body, field) {
              const regex = new RegExp(
                `### ${field}\\s*\\n([^\\n]+)`,
                "i"
              );
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            }

            for (const issue of issues) {
              const body = issue.body || "";

              const internal = extract(body, "Internal DOI Number");
              if (!internal) continue;

              registry[internal] = {
                title: extract(body, "Article Title"),
                authors: extract(body, "Authors"),
                year: extract(body, "Publication Year"),
                keywords: extract(body, "Keywords")
                  .split(",")
                  .map(k => k.trim())
                  .filter(Boolean),
                zenodo_doi: extract(body, "Official Zenodo DOI URL")
              };
            }

            fs.writeFileSync(
              "data/doi_registry.json",
              JSON.stringify(registry, null, 2)
            );

      - name: Commit and push registry
        run: |
          git config user.name "ijbmrs-bot"
          git config user.email "bot@ijbmrs.org"
          git add data/doi_registry.json
          git commit -m "Auto-update DOI registry from GitHub issues" || echo "No changes"
          git push
