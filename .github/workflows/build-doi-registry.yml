name: Build DOI Registry

on:
  issues:
    types: [opened, edited, closed, reopened]
  workflow_dispatch:

permissions:
  contents: write
  issues: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Generate and publish DOI registry
        uses: actions/github-script@v7
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const path = "data/doi_registry.json";

            // Fetch all open DOI issues
            const issues = await github.paginate(
              github.rest.issues.listForRepo,
              {
                owner,
                repo,
                labels: "doi-record",
                state: "open"
              }
            );

            function extract(body, field) {
              const regex = new RegExp(
                `### ${field}\\s*\\n([^\\n]+)`,
                "i"
              );
              const match = body.match(regex);
              return match ? match[1].trim() : "";
            }

            const registry = {};

            for (const issue of issues) {
              const body = issue.body || "";
              const internal = extract(body, "Internal DOI Number");
              if (!internal) continue;

              registry[internal] = {
                title: extract(body, "Article Title"),
                authors: extract(body, "Authors"),
                year: extract(body, "Publication Year"),
                keywords: extract(body, "Keywords")
                  .split(",")
                  .map(k => k.trim())
                  .filter(Boolean),
                zenodo_doi: extract(body, "Official Zenodo DOI URL")
              };
            }

            const content = Buffer
              .from(JSON.stringify(registry, null, 2))
              .toString("base64");

            // Get existing file SHA (if exists)
            let sha = null;
            try {
              const existing = await github.rest.repos.getContent({
                owner,
                repo,
                path
              });
              sha = existing.data.sha;
            } catch (e) {
              // file does not exist yet
            }

            // Create or update file via GitHub API
            await github.rest.repos.createOrUpdateFileContents({
              owner,
              repo,
              path,
              message: "Auto-update DOI registry from GitHub issues",
              content,
              sha
            });
